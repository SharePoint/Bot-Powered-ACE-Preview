# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

{
    "target_defaults": {
        "msvs_configuration_attributes": {
            "OutputDirectory": ""
        }
    },    
    "targets": [
        {
            "target_name": "orchestrator-core",
            "cflags": [ "-std=c++17", ],
            "cflags!": [
                "-fno-exceptions"
            ],
            "cflags_cc!": [
                "-fno-exceptions"
            ],
            "sources": [
                "load_nlr.cc",
                "oc_node.cc",
                "orchestrator_node.cc",
                "label_resolver_node.cc",
                "validate_parameters.cc",
                "marshal.cc",
            ],
            "include_dirs": [
                "../oc_abi",
                "<!@(node -p \"__dirname + '/node_modules/node-addon-api'\")"
            ],
            "defines": [
                "NAPI_DISABLE_CPP_EXCEPTIONS",
                "OC_AUTHORING"
            ],
            "conditions": [
                [ 'OS=="win"', {
                    "defines": [ "PLATFORM_WINDOWS" ],
                    "cflags+": [ "-std=c++17", "/EHs" ],
                    "cflags_c+": [ "-std=c++17" ],
                    "cflags_cc+": [ "-std=c++17" ],
                }],
                [ 'OS=="mac"', {
                    "xcode_settings": {
                        "OTHER_CPLUSPLUSFLAGS" : [ "-std=c++17", "-stdlib=libc++", "-pthread", "-Wc++17-extensions" ],
                        "OTHER_LDFLAGS": [ "-stdlib=libc++" ],
                        "MACOSX_DEPLOYMENT_TARGET": "10.14",
                        "GCC_ENABLE_CPP_RTTI": "YES",
                        "GCC_ENABLE_CPP_EXCEPTIONS": "YES"
                    },
                    'defines': ['PLATFORM_APPLE', ],
                  }],
                [ 'OS=="linux"', {
                    'defines': ['PLATFORM_LINUX', ],
                  }],

            ],            
            'configurations': {
                'Debug': {
                    'msvs_settings': {
                        'VCCLCompilerTool': {
                            'RuntimeLibrary': '3', # /MDd
                            'AdditionalOptions': [ '/EHs', '/std:c++17' ]
                        },
                    },
                },
                'Release': {
                    'msvs_settings': {
                        'VCCLCompilerTool': {
                            'RuntimeLibrary': '2', # /MD
                            'AdditionalOptions': [ '/EHs', '/std:c++17' ]
                        },
                    },
                },
            },
            "conditions": [
                [
                    "OS==\"win\"", {
                        "conditions": [
                            ["target_arch=='ia32'", {
                                "libraries": [
                                    "<(module_root_dir)/../../Release32/oc_abi.lib",
                                    "<(module_root_dir)/../../Release32/oc_sentencepiece.lib"
                                ],
                                "copies": [
                                    {
                                        "destination": "<(module_root_dir)/",
                                        "files": [
                                            "<(module_root_dir)/../dep/lib/icu32/bin/icudt66.dll",
                                            "<(module_root_dir)/../dep/lib/icu32/bin/icuin66.dll",
                                            "<(module_root_dir)/../dep/lib/icu32/bin/icuuc66.dll",
                                            "<(module_root_dir)/../../Release32/oc_abi.dll",
                                            "<(module_root_dir)/../../Release32/oc_sentencepiece.dll",
                                            "<(module_root_dir)/../dep/lib/onnxruntime32/lib/onnxruntime.dll"
                                        ]
                                    }
                                ]
                            }],
                            ["target_arch=='x64'", {
                                "libraries": [
                                    "<(module_root_dir)/../../Release/oc_abi.lib",
                                    "<(module_root_dir)/../../Release/oc_sentencepiece.lib"
                                ],
                                "copies": [
                                    {
                                        "destination": "<(module_root_dir)/",
                                        "files": [
                                            "<(module_root_dir)/../dep/lib/icu/bin64/icudt66.dll",
                                            "<(module_root_dir)/../dep/lib/icu/bin64/icuin66.dll",
                                            "<(module_root_dir)/../dep/lib/icu/bin64/icuuc66.dll",
                                            "<(module_root_dir)/../../Release/oc_abi.dll",
                                            "<(module_root_dir)/../../Release/oc_abi.lib",
                                            "<(module_root_dir)/../../Release/oc_sentencepiece.dll",
                                            "<(module_root_dir)/../dep/lib/onnxruntime/lib/onnxruntime.dll"
                                        ]
                                    }
                                ]
                            }]
                        ]
                    },
                    "OS==\"mac\"", {
                      "link_settings": {
                        "libraries": [
                            "-Wl,-rpath,@loader_path/.",
                            "<(module_root_dir)/../liboc_abi.dylib",
                            "<(module_root_dir)/../dep/lib/libsentencepiece.0.dylib",
                            "<(module_root_dir)/../dep/lib/onnxruntime/lib/libonnxruntime.dylib",
                            "<(module_root_dir)/../dep/lib/onnxruntime/lib/libonnxruntime.1.7.0.dylib",
                            "<(module_root_dir)/../dep/lib/icu/lib/libicudata.67.dylib",
                            "<(module_root_dir)/../dep/lib/icu/lib/libicuuc.67.dylib",
                            "<(module_root_dir)/../dep/lib/icu/lib/libicui18n.67.dylib"
                            ],
                        },
                        "copies": [
                            {
                                "destination": "<(module_root_dir)/",
                                "files": [
                                    "<(module_root_dir)/../dep/lib/icu/lib/libicui18n.67.dylib",
                                    "<(module_root_dir)/../dep/lib/icu/lib/libicuuc.67.dylib",
                                    "<(module_root_dir)/../dep/lib/icu/lib/libicudata.67.dylib",
                                    "<(module_root_dir)/../dep/lib/libsentencepiece.0.dylib",
                                    "<(module_root_dir)/../liboc_abi.dylib",
                                    "<(module_root_dir)/../liboc_abi.1.dylib",
                                    "<(module_root_dir)/../liboc_abi.1.0.1.dylib",
                                    "<(module_root_dir)/../dep/lib/onnxruntime/lib/libonnxruntime.dylib",
                                    "<(module_root_dir)/../dep/lib/onnxruntime/lib/libonnxruntime.1.7.0.dylib"
                                ]
                            }
                        ]
                    },
                    "OS==\"linux\"", {
                        "link_settings": {
                        "libraries": [
                            "-Wl,-rpath,'$$ORIGIN'",
                            "-L<(module_root_dir)/../",
                            "-L<(module_root_dir)/../dep/lib/onnxruntime/lib/",
                            "-L<(module_root_dir)/",
                            "-loc_abi",
                            "-lonnxruntime",
                            "-licuuc",
                            "-licui18n",
                            "-licudata",
                            "-lstdc++fs",
                            "-lsentencepiece"
                            ],
                        },
                        "copies": [
                            {
                                "destination": "<(module_root_dir)/",
                                "files": [
                                    "<(module_root_dir)/../../../icu4c-build/lib/libicui18n.so.67",
                                    "<(module_root_dir)/../../../icu4c-build/lib/libicuuc.so.67",
                                    "<(module_root_dir)/../../../icu4c-build/lib/libicudata.so.67",
                                    "<(module_root_dir)/../liboc_abi.so.1",
                                    "<(module_root_dir)/../dep/lib/libsentencepiece.so.0",
                                    "<(module_root_dir)/../dep/lib/onnxruntime/lib/libonnxruntime.so",
                                    "<(module_root_dir)/../dep/lib/onnxruntime/lib/libonnxruntime.so.1.7.0"
                                ]
                            }
                        ]
                    }
                ]
            ]
        }
    ]
}
